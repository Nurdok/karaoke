{% extends "base.html" %}

{% block subtitle %}Start Session{% endblock %}

{% block content %}
<div id="start-session-form">
    <p>Who's singing tonight?</p>
    <div>
        <form>
            {% for user in users %}
            <p>
                <input type="checkbox" id="user-{{ user.id }}" name="user-{{ user.id }}" value="{{ user.id }}" class="user-checkbox"/>
                <label for="user-{{ user.id }}">{{ user.name }}</label>
            </p>
            {% endfor %}
            <input type="button" value="Start session!" onclick="submitForm()" />
        </form>
    </div>
</div>

<div id="session-details">
    <p>Your session ID is:</p>
    <h1 id="session-id"></h1>

    <form id="goto-session" action="/player">
        <input type="hidden" id="hidden-session-id" name="s" value="" />
        <button type="submit">Go to player!</button>
    </form>
</div>

<script>
    let user = getUserOrRedirectToLoginPage();
    document.getElementById("user-" + user.id).checked = true;
    document.getElementById("session-details").style.display = "none";
    document.getElementById("start-session-form").style.display = "block";


    function submitForm() {
        let user_ids = [];
        checkboxes = document.getElementsByClassName("user-checkbox");
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                user_ids.push(checkboxes[i].value);
            }
        }

        let data = {
            user_ids: user_ids,
        };

        fetch('/api/create-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
                .then(response => response.json())
                .then(response_data => {
                    document.getElementById("session-id").innerText = response_data.session_id;
                    document.getElementById("session-details").style.display = "block";
                    document.getElementById("start-session-form").style.display = "none";
                    document.getElementById("hidden-session-id").value = response_data.session_id;
                });

    }
</script>
{% endblock %}
